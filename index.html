<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Premium - Monitoramento de Milhas</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-gradient {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card {
            transition: all 0.3s ease;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .chart-container {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 0 40px rgba(102, 126, 234, 0.6); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .apexcharts-tooltip {
            background: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid rgba(102, 126, 234, 0.5) !important;
            color: #fff !important;
        }
        
        .table-container {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
    </style>
</head>
<body>
    
    <!-- Hero Section -->
    <div class="hero-gradient py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-5xl font-bold gradient-text text-center mb-2">Dashboard Premium Milhas</h1>
            <p class="text-center text-gray-400 text-lg">Monitoramento em Tempo Real de Ofertas</p>
        </div>
    </div>
    
    <!-- Configuration Section -->
    <div class="container mx-auto px-4 py-8">
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Config Card -->
            <div class="card card-gradient shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl gradient-text">‚öôÔ∏è Configura√ß√£o</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300">Supabase URL</span>
                        </label>
                        <input type="text" id="supabaseUrl" placeholder="https://seu-projeto.supabase.co" 
                               class="input input-bordered bg-slate-800 text-white" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300">Supabase Anon Key</span>
                        </label>
                        <input type="password" id="supabaseKey" placeholder="eyJhbGc..." 
                               class="input input-bordered bg-slate-800 text-white" />
                    </div>
                    <button id="btnConnect" class="btn btn-primary mt-4 pulse-glow">
                        üîå Conectar ao Supabase
                    </button>
                </div>
            </div>
            
            <!-- Filters Card -->
            <div class="card card-gradient shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl gradient-text">üîç Filtros</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300">Data In√≠cio</span>
                        </label>
                        <input type="date" id="startDate" class="input input-bordered bg-slate-800 text-white" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300">Data Fim</span>
                        </label>
                        <input type="date" id="endDate" class="input input-bordered bg-slate-800 text-white" />
                    </div>
                    <div class="form-control">
                        <label class="cursor-pointer label">
                            <span class="label-text text-gray-300">Descartar registros vazios</span>
                            <input type="checkbox" id="discardEmpty" checked class="checkbox checkbox-primary" />
                        </label>
                    </div>
                    <button id="btnRefresh" class="btn btn-accent mt-4">
                        üîÑ Atualizar Dados
                    </button>
                </div>
            </div>
        </div>
        
        <!-- KPI Cards -->
        <div id="kpiContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" style="display:none;">
            <div class="stat-card rounded-xl p-6">
                <div class="text-gray-400 text-sm mb-2">Total de Ofertas</div>
                <div id="kpiTotal" class="text-4xl font-bold gradient-text">0</div>
            </div>
            <div class="stat-card rounded-xl p-6">
                <div class="text-gray-400 text-sm mb-2">√öltima Atualiza√ß√£o</div>
                <div id="kpiLastUpdate" class="text-lg font-semibold text-white">--</div>
            </div>
            <div class="stat-card rounded-xl p-6">
                <div class="text-gray-400 text-sm mb-2">Ofertas (24h)</div>
                <div id="kpi24h" class="text-4xl font-bold gradient-text">0</div>
            </div>
            <div class="stat-card rounded-xl p-6">
                <div class="text-gray-400 text-sm mb-2">Pico/Hora</div>
                <div id="kpiPeak" class="text-4xl font-bold gradient-text">0</div>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div id="chartsContainer" class="grid md:grid-cols-2 gap-6 mb-8" style="display:none;">
            <!-- Hourly Chart -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">üìä Ofertas por Hora (24h)</h3>
                <div id="chartHourly" style="height: 300px;"></div>
            </div>
            
            <!-- Daily Chart -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">üìà Ofertas por Dia (5 dias)</h3>
                <div id="chartDaily" style="height: 300px;"></div>
            </div>
            
            <!-- Cabin Chart -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">‚úàÔ∏è Distribui√ß√£o por Cabine</h3>
                <div id="chartCabin" style="height: 300px;"></div>
            </div>
            
            <!-- Program Chart -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">üé´ Distribui√ß√£o por Programa</h3>
                <div id="chartProgram" style="height: 300px;"></div>
            </div>
            
            <!-- Top Origins -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">ÔøΩÔøΩ Top 5 Origens</h3>
                <div id="chartOrigins" style="height: 300px;"></div>
            </div>
            
            <!-- Top Destinations -->
            <div class="chart-container">
                <h3 class="text-xl font-bold text-white mb-4">üéØ Top 5 Destinos</h3>
                <div id="chartDestinations" style="height: 300px;"></div>
            </div>
        </div>
        
        <!-- Data Quality -->
        <div id="qualityContainer" class="chart-container mb-8" style="display:none;">
            <h3 class="text-xl font-bold text-white mb-4">üîç Qualidade dos Dados</h3>
            <div id="chartQuality" style="height: 300px;"></div>
        </div>
        
        <!-- Latest Offers Table -->
        <div id="tableContainer" class="table-container p-6" style="display:none;">
            <h3 class="text-2xl font-bold text-white mb-4">üÜï √öltimas 10 Ofertas</h3>
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr class="text-gray-300">
                            <th>Origem</th>
                            <th>Destino</th>
                            <th>Milhas</th>
                            <th>Cabine</th>
                            <th>Programa</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-white">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
    // ============= UTILITIES =============
    const Utils = {
        showToast(msg, type='info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            const toast = document.createElement('div');
            toast.className = `alert ${colors[type]} text-white fixed top-4 right-4 max-w-sm z-50 shadow-2xl`;
            toast.innerHTML = `<span>${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        
        formatDate(d) {
            if (!d) return '--';
            const dt = new Date(d);
            return dt.toLocaleString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        },
        
        normalizeField(obj, field) {
            const variations = [field, field.toLowerCase(), field.charAt(0).toUpperCase() + field.slice(1).toLowerCase()];
            for (let v of variations) {
                if (obj[v] !== undefined && obj[v] !== null) return obj[v];
            }
            return null;
        }
    };
    
    // ============= SUPABASE MANAGER =============
    const SupabaseManager = {
        client: null,
        supabaseUrl: '',
        tableName: 'Rotas Encontradas',
        
        initialize(key, url = null) {
            if (url && url.trim()) this.supabaseUrl = url.trim();
            const { createClient } = supabase;
            this.client = createClient(this.supabaseUrl, key.trim());
            return true;
        },
        
        async fetchData(filters = {}) {
            let query = this.client.from(this.tableName).select('*');
            if (filters.startDate) query = query.gte('created_at', filters.startDate);
            if (filters.endDate) query = query.lte('created_at', filters.endDate);
            const { data, error } = await query.order('created_at', { ascending: false });
            if (error) throw error;
            return data || [];
        },
        
        subscribeToChanges(callback) {
            return this.client
                .channel('table-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: this.tableName }, 
                    callback)
                .subscribe();
        }
    };
    
    // ============= CHART MANAGER =============
    const ChartManager = {
        charts: {},
        
        destroy(id) {
            if (this.charts[id]) {
                this.charts[id].destroy();
                delete this.charts[id];
            }
        },
        
        createLineChart(id, data) {
            this.destroy(id);
            const options = {
                series: [{
                    name: 'Ofertas',
                    data: data.values
                }],
                chart: {
                    type: 'area',
                    height: 300,
                    background: 'transparent',
                    toolbar: { show: false },
                    animations: { enabled: true, speed: 800 }
                },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 3, colors: ['#667eea'] },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.2,
                        stops: [0, 90, 100]
                    }
                },
                xaxis: {
                    categories: data.labels,
                    labels: { style: { colors: '#94a3b8' } }
                },
                yaxis: {
                    labels: { style: { colors: '#94a3b8' } }
                },
                grid: {
                    borderColor: '#334155',
                    strokeDashArray: 5
                },
                tooltip: {
                    theme: 'dark',
                    x: { show: true }
                }
            };
            this.charts[id] = new ApexCharts(document.getElementById(id), options);
            this.charts[id].render();
        },
        
        createBarChart(id, data) {
            this.destroy(id);
            const options = {
                series: [{
                    name: 'Ofertas',
                    data: data.values
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    background: 'transparent',
                    toolbar: { show: false },
                    animations: { enabled: true, speed: 800 }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '60%',
                        borderRadius: 8,
                        dataLabels: { position: 'top' }
                    }
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -20,
                    style: { colors: ['#fff'] }
                },
                colors: ['#764ba2'],
                xaxis: {
                    categories: data.labels,
                    labels: { style: { colors: '#94a3b8' } }
                },
                yaxis: {
                    labels: { style: { colors: '#94a3b8' } }
                },
                grid: {
                    borderColor: '#334155',
                    strokeDashArray: 5
                },
                tooltip: {
                    theme: 'dark'
                }
            };
            this.charts[id] = new ApexCharts(document.getElementById(id), options);
            this.charts[id].render();
        },
        
        createDonutChart(id, data) {
            this.destroy(id);
            const options = {
                series: data.values,
                chart: {
                    type: 'donut',
                    height: 300,
                    background: 'transparent',
                    animations: { enabled: true, speed: 800 }
                },
                labels: data.labels,
                colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'],
                dataLabels: {
                    enabled: true,
                    style: { colors: ['#fff'] }
                },
                legend: {
                    position: 'bottom',
                    labels: { colors: '#94a3b8' }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                name: { color: '#94a3b8' },
                                value: { color: '#fff', fontSize: '22px' },
                                total: {
                                    show: true,
                                    color: '#94a3b8',
                                    label: 'Total'
                                }
                            }
                        }
                    }
                },
                tooltip: {
                    theme: 'dark'
                }
            };
            this.charts[id] = new ApexCharts(document.getElementById(id), options);
            this.charts[id].render();
        }
    };
    
    // ============= MAIN APP =============
    const App = {
        data: [],
        pollInterval: null,
        subscription: null,
        
        init() {
            this.loadConfig();
            this.bindEvents();
            this.setDefaultDates();
        },
        
        loadConfig() {
            const url = localStorage.getItem('supabaseUrl');
            const key = localStorage.getItem('supabaseKey');
            if (url) document.getElementById('supabaseUrl').value = url;
            if (key) document.getElementById('supabaseKey').value = key;
            if (url && key) this.connect();
        },
        
        setDefaultDates() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 5);
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
        },
        
        bindEvents() {
            document.getElementById('btnConnect').addEventListener('click', () => this.connect());
            document.getElementById('btnRefresh').addEventListener('click', () => this.refresh());
        },
        
        connect() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                Utils.showToast('‚ùå Preencha URL e Key!', 'error');
                return;
            }
            
            try {
                SupabaseManager.initialize(key, url);
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                Utils.showToast('‚úÖ Conectado com sucesso!', 'success');
                this.refresh();
                this.startPolling();
                this.subscribeRealtime();
            } catch (e) {
                Utils.showToast('‚ùå Erro ao conectar: ' + e.message, 'error');
            }
        },
        
        async refresh() {
            const filters = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };
            
            try {
                let data = await SupabaseManager.fetchData(filters);
                
                if (document.getElementById('discardEmpty').checked) {
                    data = data.filter(r => {
                        const origem = Utils.normalizeField(r, 'origem');
                        const destino = Utils.normalizeField(r, 'destino');
                        return origem && destino && origem.trim() && destino.trim();
                    });
                }
                
                this.data = data;
                this.render();
                Utils.showToast('‚úÖ Dados atualizados!', 'success');
            } catch (e) {
                Utils.showToast('‚ùå Erro ao buscar dados: ' + e.message, 'error');
            }
        },
        
        startPolling() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(() => this.refresh(), 60000);
        },
        
        subscribeRealtime() {
            if (this.subscription) this.subscription.unsubscribe();
            this.subscription = SupabaseManager.subscribeToChanges(() => this.refresh());
        },
        
        render() {
            this.renderKPIs();
            this.renderCharts();
            this.renderTable();
            
            document.getElementById('kpiContainer').style.display = 'grid';
            document.getElementById('chartsContainer').style.display = 'grid';
            document.getElementById('qualityContainer').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'block';
        },
        
        renderKPIs() {
            const total = this.data.length;
            const last24h = this.data.filter(r => {
                const created = new Date(r.created_at);
                const now = new Date();
                return (now - created) < 24 * 60 * 60 * 1000;
            }).length;
            
            const hourCounts = {};
            this.data.forEach(r => {
                const h = new Date(r.created_at).getHours();
                hourCounts[h] = (hourCounts[h] || 0) + 1;
            });
            const peak = Math.max(...Object.values(hourCounts), 0);
            
            const lastUpdate = this.data.length > 0 ? 
                Utils.formatDate(this.data[0].created_at) : '--';
            
            document.getElementById('kpiTotal').textContent = total;
            document.getElementById('kpi24h').textContent = last24h;
            document.getElementById('kpiPeak').textContent = peak;
            document.getElementById('kpiLastUpdate').textContent = lastUpdate;
        },
        
        renderCharts() {
            // Hourly
            const hourCounts = {};
            for (let h = 0; h < 24; h++) hourCounts[h] = 0;
            this.data.filter(r => {
                const created = new Date(r.created_at);
                const now = new Date();
                return (now - created) < 24 * 60 * 60 * 1000;
            }).forEach(r => {
                const h = new Date(r.created_at).getHours();
                hourCounts[h]++;
            });
            ChartManager.createLineChart('chartHourly', {
                labels: Object.keys(hourCounts).map(h => `${h}h`),
                values: Object.values(hourCounts)
            });
            
            // Daily
            const dayCounts = {};
            this.data.forEach(r => {
                const day = new Date(r.created_at).toISOString().split('T')[0];
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            const sortedDays = Object.keys(dayCounts).sort().slice(-5);
            ChartManager.createBarChart('chartDaily', {
                labels: sortedDays,
                values: sortedDays.map(d => dayCounts[d])
            });
            
            // Cabin
            const cabinCounts = {};
            this.data.forEach(r => {
                const cabin = Utils.normalizeField(r, 'cabine') || 'Desconhecido';
                cabinCounts[cabin] = (cabinCounts[cabin] || 0) + 1;
            });
            ChartManager.createDonutChart('chartCabin', {
                labels: Object.keys(cabinCounts),
                values: Object.values(cabinCounts)
            });
            
            // Program
            const programCounts = {};
            this.data.forEach(r => {
                const prog = Utils.normalizeField(r, 'programa') || 'Desconhecido';
                programCounts[prog] = (programCounts[prog] || 0) + 1;
            });
            ChartManager.createDonutChart('chartProgram', {
                labels: Object.keys(programCounts),
                values: Object.values(programCounts)
            });
            
            // Top Origins
            const originCounts = {};
            this.data.forEach(r => {
                const orig = Utils.normalizeField(r, 'origem') || 'Desconhecido';
                originCounts[orig] = (originCounts[orig] || 0) + 1;
            });
            const topOrigins = Object.entries(originCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            ChartManager.createBarChart('chartOrigins', {
                labels: topOrigins.map(x => x[0]),
                values: topOrigins.map(x => x[1])
            });
            
            // Top Destinations
            const destCounts = {};
            this.data.forEach(r => {
                const dest = Utils.normalizeField(r, 'destino') || 'Desconhecido';
                destCounts[dest] = (destCounts[dest] || 0) + 1;
            });
            const topDests = Object.entries(destCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            ChartManager.createBarChart('chartDestinations', {
                labels: topDests.map(x => x[0]),
                values: topDests.map(x => x[1])
            });
            
            // Data Quality
            const totalRecords = this.data.length;
            const validRecords = this.data.filter(r => {
                const origem = Utils.normalizeField(r, 'origem');
                const destino = Utils.normalizeField(r, 'destino');
                return origem && destino && origem.trim() && destino.trim();
            }).length;
            const invalidRecords = totalRecords - validRecords;
            
            ChartManager.createDonutChart('chartQuality', {
                labels: ['V√°lidos', 'Inv√°lidos/Vazios'],
                values: [validRecords, invalidRecords]
            });
        },
        
        renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            this.data.slice(0, 10).forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${Utils.normalizeField(r, 'origem') || '--'}</td>
                    <td>${Utils.normalizeField(r, 'destino') || '--'}</td>
                    <td>${Utils.normalizeField(r, 'milhas') || '--'}</td>
                    <td>${Utils.normalizeField(r, 'cabine') || '--'}</td>
                    <td>${Utils.normalizeField(r, 'programa') || '--'}</td>
                    <td>
                        ${Utils.normalizeField(r, 'link') ? 
                            `<a href="${Utils.normalizeField(r, 'link')}" target="_blank" class="btn btn-xs btn-primary">üîó Ver</a>` : 
                            '--'}
                    </td>
                `;
            });
        }
    };
    
    // Initialize app
    App.init();
    </script>
</body>
</html>